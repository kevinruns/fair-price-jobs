{% extends "layout.html" %}
{% from "macros.html" import rating_badge, job_type_badge, display_name %}

{% block main %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ _('Search Jobs' ) }}</h1>
        <a href="{{ url_for('search.search_tradesmen', message='To add a new job, you first must select the tradesman responsible for the job.<br>If the tradesman is not in the database, please add.' ) }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Add Job
        </a>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="col-md-4">
                    <label for="search_term" class="form-label">{{ _('Search Jobs' ) }}</label>
                    <input type="text" class="form-control" id="search_term" name="search_term" 
                           value="{{ search_term }}" placeholder="Enter keywords to search job titles...">
                </div>
                
                <div class="col-md-2">
                    <label for="trade" class="form-label">{{ _('Trade' ) }}</label>
                    <select class="form-select" id="trade" name="trade">
                        <option value="">{{ _('All Trades' ) }}</option>
                        {% for trade in trades %}
                            <option value="{{ trade }}" {% if trade == selected_trade %}selected{% endif %}>
                                {{ trade }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="rating" class="form-label">{{ _('Min Rating' ) }}</label>
                    <select class="form-select" id="rating" name="rating">
                        <option value="">{{ _('Any' ) }}</option>
                        <option value="5" {% if selected_rating == '5' %}selected{% endif %}>{{ _('5★' ) }}</option>
                        <option value="4" {% if selected_rating == '4' %}selected{% endif %}>{{ _('4★+' ) }}</option>
                        <option value="3" {% if selected_rating == '3' %}selected{% endif %}>{{ _('3★+' ) }}</option>
                        <option value="2" {% if selected_rating == '2' %}selected{% endif %}>{{ _('2★+' ) }}</option>
                        <option value="1" {% if selected_rating == '1' %}selected{% endif %}>{{ _('1★+' ) }}</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="added_by_user" class="form-label">{{ _('Added By' ) }}</label>
                    <select class="form-select" id="added_by_user" name="added_by_user">
                        <option value="">{{ _('All Users' ) }}</option>
                        {% for user in users %}
                            <option value="{{ user.username }}" {% if user.username == selected_user %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="group" class="form-label">{{ _('Group' ) }}</label>
                    <select class="form-select" id="group" name="group">
                        <option value="">{{ _('All Groups' ) }}</option>
                        {% for group in groups %}
                            <option value="{{ group.name }}" {% if group.name == selected_group %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">{{ _('Search' ) }}</button>
                    <a href="{{ url_for('search.search_jobs_quotes' ) }}" class="btn btn-secondary">{{ _('Clear' ) }}</a>
                </div>
            </form>
        </div>
    </div>

    {% if jobs %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ _('Trade' ) }}</th>
                        <th>{{ _('Job Title' ) }}</th>
                        <th>{{ _('Tradesman' ) }}</th>
                        <th>{{ _('Completed' ) }}</th>
                        <th>{{ _('Cost' ) }}</th>
                        <th>{{ _('Rating' ) }}</th>
                        <th>{{ _('Added By' ) }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                        <tr>
                            <td>{{ job.trade }}</td>
                            <td>
                                <a href="{{ url_for('jobs.view_job', job_id=job.id) }}" class="text-decoration-none">
                                    <span class="fw-semibold text-primary">{{ job.title }}</span>
                                </a>
                            </td>
                            <td>
                                <a href="{{ url_for('tradesmen.view_tradesman', tradesman_id=job.tradesman_id) }}" class="text-decoration-none">
                                    {{ display_name(job.first_name, job.family_name, job.company_name) }}</a>
                            </td>
                            <td>
                                {% if job.date_finished %}
                                    <span class="text-success">{{ job.date_finished }}</span>
                                {% else %}
                                    <span class="text-warning">{{ _('In Progress' ) }}</span>
                                {% endif %}
                            </td>
                            <td>£{{ job.total_cost }}</td>
                            <td>{{ rating_badge(job.rating) }}</td>
                            <td>
                                <a href="{{ url_for('profile.user_profile', user_id=job.added_by_user_id) }}" class="text-decoration-none">
                                    <span class="text-info">{{ job.added_by_username }}</span>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif request.method == "POST" %}
        <div class="alert alert-info">
            No jobs found matching your search criteria.
        </div>
    {% else %}
        <div class="text-center py-4">
            <p class="text-muted">{{ _('Search for completed jobs by keywords in the job title.' ) }}</p>
            <p class="text-muted small">{{ _('You can also filter by trade type and minimum rating.' ) }}</p>
        </div>
    {% endif %}
</div>
{% endblock %} 