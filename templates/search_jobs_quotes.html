{% extends "layout.html" %}
{% from "macros.html" import rating_badge, job_type_badge, display_name, date_display %}

{% block title %}
    Search Jobs & Quotes
{% endblock %}

{% block main %}
    <div class="container">
        <!-- Search Jobs & Quotes Card -->
        <div class="card section-card" style="background: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-radius: 12px; padding: 24px; margin-bottom: 2rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    {% if filtered_user %}
                        <h2 class="section-title">{{ filtered_user.firstname }}'s Jobs and Quotes</h2>
                    {% else %}
                        <h2 class="section-title">{{ _('Search Jobs & Quotes') }}</h2>
                    {% endif %}
                </div>
                {% if not filtered_user %}
                <div>
                    <a href="{{ url_for('search.search_tradesmen', message=_('To add a new job or quote, you first must select the tradesman responsible.<br>If the tradesman is not in the database, please add.') ) }}" class="btn btn-secondary" style="width: 36px; height: 36px; text-align: center; line-height: 28px; padding: 0; font-size: 20px; font-weight: bold; color: #1f2937;" title="{{ _('Add Job/Quote') }}">
                        +
                    </a>
                </div>
                {% endif %}
            </div>
            
            {% if show_search_form %}
            <form method="post" class="row g-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                                 <div class="col-md-4">
                     <label for="search_term" class="form-label fw-bold">{{ _('Search Jobs & Quotes' ) }}</label>
                     <input type="text" class="form-control" id="search_term" name="search_term" 
                            value="{{ search_term }}" placeholder="{{ _('Enter keywords to search in titles...') }}">
                 </div>
                 
                 <div class="col-md-2">
                     <label for="trade" class="form-label fw-bold">{{ _('Trade' ) }}</label>
                     <select class="form-select" id="trade" name="trade">
                         <option value="">{{ _('All Trades') }}</option>
                         {% for trade in trades %}
                             <option value="{{ trade }}" {% if trade == selected_trade %}selected{% endif %}>
                                 {{ trade }}
                             </option>
                         {% endfor %}
                     </select>
                 </div>
                 
                 <div class="col-md-2">
                     <label for="rating" class="form-label fw-bold">{{ _('Minimum Rating') }}</label>
                     <select class="form-select" id="rating" name="rating">
                         <option value="">{{ _('Any') }}</option>
                         <option value="5" {% if selected_rating == '5' %}selected{% endif %}>{{ _('5★') }}</option>
                         <option value="4" {% if selected_rating == '4' %}selected{% endif %}>{{ _('4★+') }}</option>
                         <option value="3" {% if selected_rating == '3' %}selected{% endif %}>{{ _('3★+') }}</option>
                         <option value="2" {% if selected_rating == '2' %}selected{% endif %}>{{ _('2★+') }}</option>
                         <option value="1" {% if selected_rating == '1' %}selected{% endif %}>{{ _('1★+') }}</option>
                     </select>
                 </div>
                 
                 <div class="col-md-2">
                     <label for="added_by_user" class="form-label fw-bold">{{ _('Added By' ) }}</label>
                     <select class="form-select" id="added_by_user" name="added_by_user">
                         <option value="">{{ _('All Users') }}</option>
                         {% for user in users %}
                             <option value="{{ user.username }}" {% if user.username == selected_user %}selected{% endif %}>
                                 {{ user.username }}
                             </option>
                         {% endfor %}
                     </select>
                 </div>
                 
                 <div class="col-md-2">
                     <label for="group" class="form-label fw-bold">{{ _('Group') }}</label>
                     <select class="form-select" id="group" name="group">
                         <option value="">{{ _('All Groups') }}</option>
                         {% for group in groups %}
                             <option value="{{ group.name }}" {% if group.name == selected_group %}selected{% endif %}>
                                 {{ group.name }}
                             </option>
                         {% endfor %}
                     </select>
                 </div>
                
                <div class="col-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="include_jobs" name="include_jobs" 
                               {% if include_jobs == 'on' %}checked{% endif %}>
                        <label class="form-check-label" for="include_jobs">
                            {{ _("Include Jobs") }}
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="include_quotes" name="include_quotes" 
                               {% if include_quotes == 'on' %}checked{% endif %}>
                        <label class="form-check-label" for="include_quotes">
                            {{ _("Include Quotes") }}
                        </label>
                    </div>
                </div>
                
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">{{ _('Search' ) }}</button>
                    <a href="{{ url_for('search.search_jobs_quotes' ) }}" class="btn btn-secondary">{{ _('Clear') }}</a>
                </div>
            </form>
            {% endif %}
        </div>

                 {% if results %}
             <!-- Search Results Card -->
             <div class="card section-card" style="background: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-radius: 12px; padding: 24px; margin-bottom: 2rem;">
                 <div class="table-responsive">
                     <table id="jobs-search-table" class="table table-striped">
                         <thead>
                             <tr>
                                 <th class="sortable-header" data-column="icon" data-type="text">{{ _("") }}</th>
                                 <th class="sortable-header" data-column="title" data-type="text">{{ _('Title' ) }}</th>
                                 <th class="sortable-header" data-column="trade" data-type="text">{{ _('Trade' ) }}</th>
                                 <th class="sortable-header" data-column="tradesman" data-type="text">{{ _('Tradesman' ) }}</th>
                                 <th class="sortable-header" data-column="status" data-type="text">{{ _('Status' ) }}</th>
                                 <th class="sortable-header numeric" data-column="cost" data-type="number">{{ _('Price' ) }}</th>
                                 <th class="sortable-header" data-column="rating" data-type="number">{{ _('Rating' ) }}</th>
                                 {% if not filtered_user %}
                                 <th class="sortable-header" data-column="added_by" data-type="text">{{ _('Added By' ) }}</th>
                                 {% endif %}
                             </tr>
                         </thead>
                         <tbody>
                             {% for result in results %}
                                 <tr class="clickable">
                                     <td data-column="icon" class="text-center">
                                         <div class="icon-circle" title="{% if result.type == 'job' %}{{ _('Completed Job') }}{% else %}{{ _('Quote') }}{% endif %}">
                                             <i class="fas fa-{% if result.type == 'job' %}hammer{% else %}file-invoice{% endif %} text-muted"></i>
                                         </div>
                                     </td>
                                     <td data-column="title">
                                         {% if result.type == 'job' %}
                                             <a href="{{ url_for('jobs.view_job', job_id=result.id) }}" class="text-decoration-none">
                                                 <span class="fw-semibold text-primary">{{ result.title }}</span>
                                             </a>
                                         {% else %}
                                             <a href="{{ url_for('jobs.view_quote', quote_id=result.id) }}" class="text-decoration-none">
                                                 <span class="fw-semibold text-primary">{{ result.title }}</span>
                                             </a>
                                         {% endif %}
                                     </td>
                                     <td data-column="trade">{{ result.trade }}</td>
                                     <td data-column="tradesman">
                                         <a href="{{ url_for('tradesmen.view_tradesman', tradesman_id=result.tradesman_id) }}" class="text-decoration-none">
                                             {{ display_name(result.first_name, result.family_name, result.company_name) }}</a>
                                     </td>
                                     <td data-column="status">
                                         {% if result.type == 'job' %}
                                             {{ date_display(result.date_finished) }}{% else %}
                                             <span class="badge bg-{% if result.status == 'accepted' %}success{% elif result.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                                 {{ result.status|title if result.status else 'Pending' }}
                                             </span>
                                         {% endif %}
                                     </td>
                                     <td data-column="cost" class="numeric">
                                         {% if result.type == 'job' %}
                                             €{{ result.total_cost }}
                                         {% else %}
                                             €{{ result.total_quote }}
                                         {% endif %}
                                     </td>
                                     <td data-column="rating">{{ rating_badge(result.rating) }}</td>
                                     {% if not filtered_user %}
                                     <td data-column="added_by">
                                         <a href="{{ url_for('profile.user_profile', user_id=result.added_by_user_id) }}" class="text-decoration-none">
                                             <span class="text-info">{{ result.added_by_username }}</span>
                                         </a>
                                     </td>
                                     {% endif %}
                                 </tr>
                             {% endfor %}
                         </tbody>
                     </table>
                 </div>
             </div>
         {% elif request.method == "POST" %}
             <div class="alert alert-info">
                 {{ _("No jobs or quotes found matching your search criteria.") }}
             </div>
         {% else %}
             <div class="text-center py-4">
                 <p class="text-muted">{{ _('Search for jobs and quotes by keywords in the title.' ) }}</p>
                 <p class="text-muted small">{{ _('You can filter by trade type, minimum rating, and choose to include jobs, quotes, or both.' ) }}</p>
             </div>
         {% endif %}
    </div>
{% endblock %} 