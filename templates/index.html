{% extends "layout.html" %}
{% from "macros.html" import rating_badge, section_header, display_name, empty_state, status_badge, job_type_badge, date_display %}

{% block title %}
    Home
{% endblock %}

{% block main %}
    <div class="container">
        <!-- Top Rated Tradesmen Section -->
        <div class="border border-3 rounded-3 p-3 mb-4">
            {{ section_header(
                _("Top Rated Tradesmen"),
                url_for('search.search_tradesmen'),
                url_for('tradesmen.add_tradesman'),
                _("Add Tradesman"),
                _("Search Tradesmen")
            ) }}{% if tradesmen %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>{{ _("Name") }}</th>
                                <th>{{ _("Trade") }}</th>
                                <th>{{ _("Rating") }}</th>
                                <th>{{ _("Jobs") }}</th>
                                <th>{{ _("Quotes") }}</th>
                                <th>{{ _("Added By") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tradesman in tradesmen %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('tradesmen.view_tradesman', tradesman_id=tradesman.id) }}" class="text-decoration-none">
                                            <span class="fw-semibold text-primary">
                                                {{ display_name(tradesman.first_name, tradesman.family_name, tradesman.company_name) }}</span>
                                        </a>
                                    </td>
                                    <td>{{ tradesman.trade }}</td>
                                    <td>{{ rating_badge(tradesman.rating) }}</td>
                                    <td><span class="badge bg-info">{{ tradesman.job_count }}</span></td>
                                    <td><span class="badge bg-warning">{{ tradesman.quote_count }}</span></td>
                                    <td>
                                        <a href="{{ url_for('profile.user_profile', user_id=tradesman.added_by_user_id) }}" class="text-decoration-none">
                                            <span class="text-info">{{ tradesman.added_by_username }}</span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                {{ empty_state(_("No rated tradesmen found. Top-rated tradesmen will appear here when you or your group members add tradesmen and complete jobs with ratings.")) }}{% endif %}
        </div>

        <!-- Recently Completed Jobs & Quotes Section -->
        <div class="border border-3 rounded-3 p-3 mb-4">
            {{ section_header(
                _("Recent Jobs & Quotes"),
                url_for('search.search_jobs_quotes'),
                url_for('search.search_tradesmen', message='To add a job, first select or create the tradesman'),
                _("Ajouter un Travail ou Devis"),
                _("Search Jobs & Quotes")
            ) }}{% if recent_jobs %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>{{ _("Type") }}</th>
                                <th>{{ _("Title") }}</th>
                                <th>{{ _("Tradesman") }}</th>
                                <th>{{ _("Trade") }}</th>
                                <th>{{ _("Date") }}</th>
                                <th>{{ _("Cost/Quote") }}</th>
                                <th>{{ _("Rating") }}</th>
                                <th>{{ _("Added By") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in recent_jobs %}
                                {% set job_url = url_for('jobs.view_job', job_id=job.id) if job.type == 'job' else url_for('jobs.view_quote', quote_id=job.id) %}
                                {% set cost_field = job.total_cost if job.type == 'job' else job.total_quote %}
                                
                                <tr>
                                    <td>{{ job_type_badge(job.type) }}</td>
                                    <td>
                                        <a href="{{ job_url }}" class="text-decoration-none">
                                            <span class="fw-semibold text-primary">{{ job.title }}</span>
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('tradesmen.view_tradesman', tradesman_id=job.tradesman_id) }}" class="text-decoration-none">
                                            {{ display_name(job.first_name, job.family_name, job.company_name) }}</a>
                                    </td>
                                    <td>{{ job.trade }}</td>
                                    <td>{{ date_display(job.date_finished) }}</td>
                                    <td>â‚¬{{ cost_field }}</td>
                                    <td>{{ rating_badge(job.rating) }}</td>
                                    <td>
                                        <a href="{{ url_for('profile.user_profile', user_id=job.added_by_user_id) }}" class="text-decoration-none">
                                            <span class="text-info">{{ job.added_by_username }}</span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                {{ empty_state(_("No recently completed jobs found. Jobs will appear here when you or members of your groups complete work with tradesmen.")) }}{% endif %}
        </div>

        <!-- My Groups Section -->
        <div class="border border-3 rounded-3 p-3 mb-4">
            {{ section_header(
                _("My Groups"),
                url_for('groups.search_groups'),
                url_for('groups.create_group'),
                _("Create Group"),
                _("Find Group")
            ) }}{% if my_groups %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>{{ _("Group Name") }}</th>
                                <th>{{ _("Postcode") }}</th>
                                <th>{{ _("Members") }}</th>
                                <th>{{ _("Votre Statut") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in my_groups %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('groups.view_group', group_id=group.id) }}" class="text-decoration-none">
                                            <span class="fw-semibold text-primary">{{ group.name }}</span>
                                        </a>
                                    </td>
                                    <td>{{ group.postcode }}</td>
                                    <td><span class="badge bg-info">{{ group.member_count }}</span></td>
                                    <td>{{ status_badge(group.status) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                                            <a href="{{ url_for('groups.search_groups' ) }}" class="btn btn-outline-primary btn-sm">{{ _("View All Groups") }}</a>
                </div>
            {% else %}
                {{ empty_state(_("You haven't joined any groups yet. Join or create groups to collaborate with others and share tradesmen recommendations.")) }}{% endif %}
        </div>
    </div>
{% endblock %}

